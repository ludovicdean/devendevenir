---
import LargeCard from "./LargeCard.astro";
import PostsList from "./PostsList.astro";

const { posts, latestPost, postYears, currentYear } = Astro.props;
const base = import.meta.env.BASE_URL;
---

<div id="search-container" data-base-url={base}>
    <div class="search-wrapper mb-6">
        <input
            type="text"
            id="search-input"
            placeholder="Rechercher des articles..."
            class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 focus:border-yellow-400 focus:outline-none text-gray-900 placeholder-gray-500"
        />
    </div>

    <div id="search-results" class="hidden">
        <!-- Search results will be inserted here -->
    </div>

    <div id="default-posts">
        <section>
            <LargeCard post={latestPost} />
            {
                Array.from(postYears.entries()).map(
                    ([year, articles]) =>
                        articles.length > 0 && (
                            <section>
                                {year !== currentYear && (
                                    <h2 class="flex justify-center">{year}</h2>
                                )}
                                <PostsList posts={articles} />
                            </section>
                        ),
                )
            }
        </section>
    </div>
</div>

<script is:inline>
    let pagefind = null;
    let searchTimeout = null;

    async function initPagefind() {
        if (!pagefind) {
            try {
                const container = document.getElementById("search-container");
                let base = container?.getAttribute("data-base-url") || "/";
                // Ensure base ends with a slash
                if (!base.endsWith("/")) {
                    base += "/";
                }
                const pagefindPath = base + "pagefind/pagefind.js";
                console.log("Loading Pagefind from:", pagefindPath);
                pagefind = await import(pagefindPath);
            } catch (error) {
                console.error("Failed to load Pagefind:", error);
            }
        }
    }

    async function performSearch(query) {
        const searchResults = document.getElementById("search-results");
        const defaultPosts = document.getElementById("default-posts");

        if (!searchResults || !defaultPosts) return;

        // If query is empty or less than 4 characters, show default posts
        if (query.length < 4) {
            searchResults.classList.add("hidden");
            defaultPosts.classList.remove("hidden");
            searchResults.innerHTML = "";
            return;
        }

        // Initialize Pagefind if needed
        await initPagefind();

        if (!pagefind) {
            console.error("Pagefind not loaded");
            return;
        }

        try {
            // Perform search
            const search = await pagefind.search(query);

            // Hide default posts, show search results
            defaultPosts.classList.add("hidden");
            searchResults.classList.remove("hidden");

            if (search.results.length === 0) {
                searchResults.innerHTML =
                    '<p class="text-center text-gray-600 py-8">Aucun article trouv√© pour cette recherche.</p>';
                return;
            }

            // Load and display results
            const results = await Promise.all(
                search.results.map((result) => result.data()),
            );

            let resultsHTML = '<ul class="flex flex-wrap gap-3">';

            results.forEach((result) => {
                const url = result.url;
                const title = result.meta?.title || "Sans titre";
                const excerpt = result.excerpt || "";

                resultsHTML += `
          <li class="relative w-full sm:w-[calc(50%-0.375rem)] md:w-[calc(33.333%-0.5rem)] list-none">
            <a href="${url}" class="flex flex-col h-full p-4 rounded-lg border-2 border-gray-200 hover:border-yellow-400 transition-colors no-underline">
              <h3 class="text-lg font-bold text-gray-900 mb-2 hover:text-yellow-400">${title}</h3>
              <p class="text-sm text-gray-600 line-clamp-3">${excerpt}</p>
            </a>
          </li>
        `;
            });

            resultsHTML += "</ul>";
            searchResults.innerHTML = resultsHTML;
        } catch (error) {
            console.error("Search error:", error);
            searchResults.innerHTML =
                '<p class="text-center text-red-600 py-8">Une erreur est survenue lors de la recherche.</p>';
        }
    }

    // Set up search input listener
    document.addEventListener("DOMContentLoaded", () => {
        const searchInput = document.getElementById("search-input");

        if (searchInput) {
            searchInput.addEventListener("input", (e) => {
                const query = e.target.value.trim();

                // Debounce search
                if (searchTimeout) {
                    clearTimeout(searchTimeout);
                }

                searchTimeout = window.setTimeout(() => {
                    performSearch(query);
                }, 300);
            });
        }
    });
</script>

<style>
    .line-clamp-3 {
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
</style>
